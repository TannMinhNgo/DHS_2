{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>So s√°nh laptop</h3>
        <a href="{{ url_for('laptops') }}" class="btn btn-outline-primary">Quay l·∫°i danh s√°ch</a>
    </div>

    {% if not items %}
    <div class="alert alert-info">
        <h5>Ch∆∞a c√≥ laptop n√†o ƒë·ªÉ so s√°nh</h5>
        <p class="mb-0">H√£y ch·ªçn √≠t nh·∫•t 2 laptop ƒë·ªÉ so s√°nh b·∫±ng c√°ch:</p>
        <ul class="mb-0 mt-2">
            <li>Th√™m <code>?id=1&id=2</code> v√†o URL</li>
            <li>Ho·∫∑c s·ª≠ d·ª•ng n√∫t "So s√°nh" t·ª´ trang danh s√°ch laptop</li>
        </ul>
    </div>
    {% else %}
    
    <!-- Th√¥ng tin t·ªïng quan -->
    <div class="row mb-4">
        {% for it in items %}
        <div class="col-md-6 col-lg-{{ 12 // items|length }} mb-3">
            <div class="card h-100 app-card">
                <img src="{{ it.image_url or 'https://via.placeholder.com/400x250?text=Laptop' }}" 
                     class="card-img-top" alt="{{ it.name }}">
                <div class="card-body">
                    <h5 class="card-title">{{ it.name }}</h5>
                    <p class="card-text text-primary fw-bold fs-4">{{ "{:,.0f}".format(it.price) }} VND</p>
                    <div class="small text-muted">
                        <div><strong>Th∆∞∆°ng hi·ªáu:</strong> {{ it.brand }}</div>
                        <div><strong>CPU:</strong> {{ it.cpu }}</div>
                        <div><strong>RAM:</strong> {{ it.ram_gb }}GB</div>
                        {% if it.gpu %}
                        <div><strong>GPU:</strong> {{ it.gpu }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- So s√°nh th·ªùi gian d√πng pin -->
    <div class="card mb-4 app-card">
        <div class="card-header app-card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">So s√°nh th·ªùi gian d√πng pin</h5>
        </div>
        <div class="card-body" id="batteryComparison">
            {% for it in items %}
            <div class="mb-4 battery-item" data-battery-life="{{ it.battery_life_office or 0 }}" data-battery-capacity="{{ it.battery_capacity or 0 }}">
                <h6 class="mb-2">{{ it.name }}</h6>
                
                <!-- Dung l∆∞·ª£ng pin -->
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-muted">Dung l∆∞·ª£ng pin</span>
                        <span class="small fw-bold">{{ it.battery_capacity or 0 }} Wh</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar battery-capacity" role="progressbar" 
                             data-width="{{ ((it.battery_capacity or 0) / 100) * 100 }}"></div>
                    </div>
                </div>
                
                <!-- Th·ªùi gian d√πng pin -->
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="small text-muted">Th·ªùi gian d√πng pin</span>
                        <span class="small fw-bold">
                            {% if it.battery_life_office %}
                                {{ (it.battery_life_office // 60) }}g {{ it.battery_life_office % 60 }}p
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar battery-life" role="progressbar" 
                             data-width="{{ ((it.battery_life_office or 0) / 1500) * 100 }}"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
            
            <div class="mt-3 p-3 bg-light rounded">
                <small class="text-muted">
                    <strong>Ghi ch√∫:</strong> Th·ªùi gian test pin ·ª©ng d·ª•ng vƒÉn ph√≤ng ƒë∆∞·ª£c ghi nh·∫≠n b·∫±ng c√°ch ch·∫°y script t·ª± ƒë·ªông h√≥a m√£ ngu·ªìn m·ªü. 
                    C√°c ƒëi·ªÅu ki·ªán th·ªèa ti√™u chu·∫©n ghi trong README c·ªßa script.
                </small>
            </div>
        </div>
    </div>

    <!-- So s√°nh ƒëi·ªÉm s·ªë CPU -->
    <div class="card mb-4 app-card">
        <div class="card-header app-card-header">
            <h5 class="mb-0">So s√°nh ƒëi·ªÉm s·ªë CPU</h5>
            <small>ƒêi·ªÉm s·ªë CPU c√†ng cao c√†ng t·ªët. ƒêi·ªÉm cao h∆°n cho th·∫•y s·ª©c m·∫°nh x·ª≠ l√Ω c·ªßa m√°y t·ªët h∆°n, gi√∫p th·ª±c hi·ªán c√°c t√°c v·ª• nhanh h∆°n v√† hi·ªáu qu·∫£ h∆°n.</small>
        </div>
        <div class="card-body">
            <!-- Ch·∫ø ƒë·ªô so s√°nh -->
            <div class="mb-3">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="switchCPUMode('battery')">D√πng pin</button>
                    <button type="button" class="btn btn-primary active" onclick="switchCPUMode('plugged')">C·∫Øm s·∫°c</button>
                </div>
            </div>
            
            <!-- Bi·ªÉu ƒë·ªì CPU -->
            <div id="cpuChart">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-center mb-3">Geekbench 6 CPU Single Core</h6>
                        {% for it in items %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="small">{{ it.name[:20] }}...</span>
                                <span class="small fw-bold">{{ it.cpu_single_core_plugged or 0 }}</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-warning" role="progressbar" 
                                     data-width="{{ ((it.cpu_single_core_plugged or 0) / 3000) * 100 }}"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-center mb-3">Geekbench 6 CPU Multi Core</h6>
                        {% for it in items %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="small">{{ it.name[:20] }}...</span>
                                <span class="small fw-bold">{{ it.cpu_multi_core_plugged or 0 }}</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     data-width="{{ ((it.cpu_multi_core_plugged or 0) / 15000) * 100 }}"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- So s√°nh ƒëi·ªÉm s·ªë GPU -->
    <div class="card mb-4 app-card">
        <div class="card-header app-card-header">
            <h5 class="mb-0">So s√°nh ƒëi·ªÉm s·ªë GPU</h5>
            <small>ƒêi·ªÉm s·ªë GPU c√†ng cao c√†ng t·ªët. ƒêi·ªÉm cao h∆°n cho th·∫•y kh·∫£ nƒÉng x·ª≠ l√Ω ƒë·ªì h·ªça t·ªët h∆°n, ph√π h·ª£p cho gaming v√† thi·∫øt k·∫ø.</small>
        </div>
        <div class="card-body">
            <!-- Ch·∫ø ƒë·ªô so s√°nh -->
            <div class="mb-3">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="switchGPUMode('battery')">D√πng pin</button>
                    <button type="button" class="btn btn-primary active" onclick="switchGPUMode('plugged')">C·∫Øm s·∫°c</button>
                </div>
            </div>
            
            <!-- Bi·ªÉu ƒë·ªì GPU -->
            <div id="gpuChart">
                {% for it in items %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="small">{{ it.name }}</span>
                        <span class="small fw-bold">{{ it.gpu_score_plugged or 0 }}</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-danger" role="progressbar" 
                             data-width="{{ ((it.gpu_score_plugged or 0) / 20000) * 100 }}"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- B·∫£ng so s√°nh chi ti·∫øt -->
    <div class="card app-card">
        <div class="card-header app-card-header">
            <h5 class="mb-0">So s√°nh chi ti·∫øt</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0 compare-table">
                    <thead class="table-light subtle-head">
                        <tr>
                            <th style="width: 200px;">Th√¥ng s·ªë</th>
                            {% for it in items %}
                            <th class="text-center">{{ it.brand }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        <!-- CPU -->
                        <tr class="table-section">
                            <th colspan="{{ items|length + 1 }}">B·ªô x·ª≠ l√Ω</th>
                        </tr>
                        <tr>
                            <td><strong>CPU</strong></td>
                            {% for it in items %}
                            <td class="text-center">
                                <span class="badge bg-info">{{ it.cpu }}</span>
                            </td>
                            {% endfor %}
                        </tr>

                        <!-- RAM -->
                        <tr class="table-section">
                            <th colspan="{{ items|length + 1 }}">B·ªô nh·ªõ</th>
                        </tr>
                        <tr>
                            <td><strong>RAM</strong></td>
                            {% for it in items %}
                            <td class="text-center">
                                <span class="badge bg-success">{{ it.ram_gb }}GB</span>
                            </td>
                            {% endfor %}
                        </tr>

                        <!-- GPU -->
                        <tr class="table-section">
                            <th colspan="{{ items|length + 1 }}">ƒê·ªì h·ªça</th>
                        </tr>
                        <tr>
                            <td><strong>GPU</strong></td>
                            {% for it in items %}
                            <td class="text-center">
                                {% if it.gpu %}
                                    {% if 'rtx' in it.gpu.lower() or 'gtx' in it.gpu.lower() %}
                                        <span class="badge bg-danger">{{ it.gpu }}</span>
                                    {% elif 'mx' in it.gpu.lower() or 'iris' in it.gpu.lower() %}
                                        <span class="badge bg-warning text-dark">{{ it.gpu }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ it.gpu }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>

                        <!-- Pin -->
                        <tr class="table-section">
                            <th colspan="{{ items|length + 1 }}">Pin</th>
                        </tr>
                        <tr>
                            <td><strong>Dung l∆∞·ª£ng</strong></td>
                            {% for it in items %}
                            <td class="text-center">
                                <span class="badge bg-info">{{ it.battery_capacity or 'N/A' }} Wh</span>
                            </td>
                            {% endfor %}
                        </tr>
                        <tr>
                            <td><strong>Th·ªùi gian d√πng</strong></td>
                            {% for it in items %}
                            <td class="text-center">
                                {% if it.battery_life_office %}
                                    <span class="badge bg-success">{{ (it.battery_life_office // 60) }}g {{ it.battery_life_office % 60 }}p</span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>

                        <!-- Gi√° c·∫£ -->
                        <tr class="table-section">
                            <th colspan="{{ items|length + 1 }}">Gi√° c·∫£</th>
                        </tr>
                        <tr>
                            <td><strong>Gi√° b√°n</strong></td>
                            {% for it in items %}
                            <td class="text-center">
                                <span class="fw-bold text-danger">{{ "{:,.0f}".format(it.price) }} VND</span>
                            </td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Nh·∫≠n x√©t theo ti√™u ch√≠ -->
    <div class="card app-card mt-4">
        <div class="card-header app-card-header">
            <h5 class="mb-0">Nh·∫≠n x√©t theo ti√™u ch√≠</h5>
        </div>
        <div class="card-body">
            {% if items and items|length >= 2 %}
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="p-3 rounded border" style="border-color: var(--border) !important; background: rgba(197,143,90,0.05);">
                        <div class="small text-muted">Gi√°/Hi·ªáu nƒÉng t·ªët nh·∫•t</div>
                        <div class="fw-bold">{{ best_price_performance.name }}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 rounded border" style="border-color: var(--border) !important; background: rgba(197,143,90,0.05);">
                        <div class="small text-muted">Hi·ªáu nƒÉng t·ªët nh·∫•t</div>
                        <div class="fw-bold">{{ best_performance.name }}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="p-3 rounded border" style="border-color: var(--border) !important; background: rgba(197,143,90,0.05);">
                        <div class="small text-muted">Gi√° t·ªët nh·∫•t</div>
                        <div class="fw-bold">{{ best_value.name }}</div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-muted">Ch·ªçn √≠t nh·∫•t 2 s·∫£n ph·∫©m ƒë·ªÉ xem nh·∫≠n x√©t theo ti√™u ch√≠.</div>
            {% endif %}
        </div>
    </div>
    
    {% endif %}
</div>

<style>
.battery-capacity { 
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600)) !important; 
}
.battery-life { 
    background: linear-gradient(135deg, #d4a373, #c58f5a) !important; 
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set width cho progress bars
    document.querySelectorAll('[data-width]').forEach(function(element) {
        const width = parseFloat(element.getAttribute('data-width'));
        element.style.width = Math.min(width, 100) + '%';
    });
    
    // L·∫•y laptop IDs t·ª´ URL
    const urlParams = new URLSearchParams(window.location.search);
    const laptopIds = urlParams.getAll('id');
    
    // L∆∞u laptop IDs ƒë·ªÉ s·ª≠ d·ª•ng cho API
    window.laptopIds = laptopIds;
    
    // S·∫Øp x·∫øp ph·∫ßn pin theo th·ªùi gian pin t·ªët h∆°n
    sortBatteryComparison();
});

// S·∫Øp x·∫øp ph·∫ßn pin theo th·ªùi gian pin t·ªët h∆°n
function sortBatteryComparison() {
    const container = document.getElementById('batteryComparison');
    if (!container) return;
    
    const batteryItems = Array.from(container.querySelectorAll('.battery-item'));
    
    // S·∫Øp x·∫øp theo th·ªùi gian pin (cao nh·∫•t l√™n ƒë·∫ßu)
    batteryItems.sort((a, b) => {
        const lifeA = parseInt(a.dataset.batteryLife) || 0;
        const lifeB = parseInt(b.dataset.batteryLife) || 0;
        return lifeB - lifeA;
    });
    
    // Th√™m icon cho laptop c√≥ pin t·ªët nh·∫•t
    batteryItems.forEach((item, index) => {
        const title = item.querySelector('h6');
        if (index === 0 && title) {
            title.innerHTML = 'ü•á ' + title.textContent;
        }
    });
    
    // S·∫Øp x·∫øp l·∫°i trong container
    batteryItems.forEach(item => {
        container.appendChild(item);
    });
}

function sortBattery(direction) {
    console.log('S·∫Øp x·∫øp pin theo:', direction);
    // C√≥ th·ªÉ implement AJAX ƒë·ªÉ s·∫Øp x·∫øp real-time
}

function switchCPUMode(mode) {
    console.log('Chuy·ªÉn mode CPU:', mode);
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
    const btnGroup = event.target.closest('.btn-group');
    btnGroup.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    const activeBtn = event.target;
    activeBtn.classList.add('active');
    activeBtn.classList.add('btn-primary');
    activeBtn.classList.remove('btn-outline-primary');
    
    // Load d·ªØ li·ªáu m·ªõi t·ª´ API
    loadCPUData(mode);
}

function switchGPUMode(mode) {
    console.log('Chuy·ªÉn mode GPU:', mode);
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t
    const btnGroup = event.target.closest('.btn-group');
    btnGroup.querySelectorAll('.btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    const activeBtn = event.target;
    activeBtn.classList.add('active');
    activeBtn.classList.add('btn-primary');
    activeBtn.classList.remove('btn-outline-primary');
    
    // Load d·ªØ li·ªáu m·ªõi t·ª´ API
    loadGPUData(mode);
}

function loadCPUData(mode) {
    if (!window.laptopIds) return;
    
    // Th√™m timestamp ƒë·ªÉ tr√°nh cache
    const timestamp = new Date().getTime();
    const url = `/api/compare_data?id=${window.laptopIds.join('&id=')}&mode=${mode}&_t=${timestamp}`;
    
    fetch(url, {
        headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
        }
    })
        .then(response => response.json())
        .then(data => {
            updateCPUCharts(data);
        })
        .catch(error => {
            console.error('L·ªói khi load d·ªØ li·ªáu CPU:', error);
        });
}

function loadGPUData(mode) {
    if (!window.laptopIds) return;
    
    // Th√™m timestamp ƒë·ªÉ tr√°nh cache
    const timestamp = new Date().getTime();
    const url = `/api/compare_data?id=${window.laptopIds.join('&id=')}&mode=${mode}&_t=${timestamp}`;
    
    fetch(url, {
        headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
        }
    })
        .then(response => response.json())
        .then(data => {
            updateGPUCharts(data);
        })
        .catch(error => {
            console.error('L·ªói khi load d·ªØ li·ªáu GPU:', error);
        });
}

function updateCPUCharts(data) {
    // S·∫Øp x·∫øp theo ƒëi·ªÉm s·ªë cao nh·∫•t (t·ªët nh·∫•t ƒë·ª©ng tr√™n)
    const sortedSingleCore = [...data.cpu_single_core].sort((a, b) => b.score - a.score);
    const sortedMultiCore = [...data.cpu_multi_core].sort((a, b) => b.score - a.score);
    
    // C·∫≠p nh·∫≠t Single Core
    const singleCoreContainer = document.querySelector('#cpuChart .col-md-6:first-child');
    singleCoreContainer.innerHTML = '<h6 class="text-center mb-3">Geekbench 6 CPU Single Core</h6>';
    
    sortedSingleCore.forEach((item, index) => {
        const width = Math.min((item.score / 3000) * 100, 100);
        const isBest = index === 0;
        singleCoreContainer.innerHTML += `
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small">
                        ${isBest ? 'ü•á ' : ''}${item.name.substring(0, 20)}...
                    </span>
                    <span class="small fw-bold">${item.score.toLocaleString()}</span>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-warning" role="progressbar" style="width: ${width}%"></div>
                </div>
            </div>
        `;
    });
    
    // C·∫≠p nh·∫≠t Multi Core
    const multiCoreContainer = document.querySelector('#cpuChart .col-md-6:last-child');
    multiCoreContainer.innerHTML = '<h6 class="text-center mb-3">Geekbench 6 CPU Multi Core</h6>';
    
    sortedMultiCore.forEach((item, index) => {
        const width = Math.min((item.score / 15000) * 100, 100);
        const isBest = index === 0;
        multiCoreContainer.innerHTML += `
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small">
                        ${isBest ? 'ü•á ' : ''}${item.name.substring(0, 20)}...
                    </span>
                    <span class="small fw-bold">${item.score.toLocaleString()}</span>
                </div>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: ${width}%"></div>
                </div>
            </div>
        `;
    });
}

function updateGPUCharts(data) {
    // S·∫Øp x·∫øp theo ƒëi·ªÉm s·ªë cao nh·∫•t (t·ªët nh·∫•t ƒë·ª©ng tr√™n)
    const sortedGPU = [...data.gpu_score].sort((a, b) => b.score - a.score);
    
    const gpuContainer = document.querySelector('#gpuChart');
    gpuContainer.innerHTML = '';
    
    sortedGPU.forEach((item, index) => {
        const width = Math.min((item.score / 20000) * 100, 100);
        const isBest = index === 0;
        gpuContainer.innerHTML += `
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small">
                        ${isBest ? 'ü•á ' : ''}${item.name}
                    </span>
                    <span class="small fw-bold">${item.score.toLocaleString()}</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar bg-danger" role="progressbar" style="width: ${width}%"></div>
                </div>
            </div>
        `;
    });
}
</script>
{% endblock %}
